<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>Sistema Fácil | Administración de Roles</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" th:href="@{/interno/plugins/fontawesome-free/css/all.min.css}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" th:href="@{/interno/dist/css/adminlte.min.css}">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" th:href="@{/interno/plugins/overlayScrollbars/css/OverlayScrollbars.min.css}">
    <!-- Personalizado -->
    <link rel="stylesheet" th:href="@{/interno/css/personalizadoRoles.css}">
	<!-- sweetalert2 -->
	<link rel="stylesheet" th:href="@{/interno/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css}">
	<meta name="_csrf" th:content="${_csrf.token}"/>
	 <meta name="_csrf-header" th:content="${_csrf.headerName}"/>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <!-- Navbar -->
	<nav class="main-header navbar navbar-expand-lg navbar-white navbar-light">
			
			<button class="navbar-toggler order-1 ml-2" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
			  <span class="navbar-toggler-icon"></span>
			</button>
					
	        <!-- Left navbar links -->
	        <ul class="navbar-nav">
	            <li class="nav-item d-none d-sm-inline-block">
	                <strong>Hola, <span th:text="${usuario.nombreUsuario}"></span></strong>
	            </li>
	        </ul>
	        
	        <ul class="navbar-nav ml-auto">
	            <li class="nav-item">
	                <a th:href="@{/logout}" class="btn btn-danger btn-sm">
	                    <i class="fas fa-sign-out-alt"></i> Cerrar sesión
	                </a>
	            </li>
	        </ul>
			
			
	    </nav>

    <!-- Sidebar -->
    <!--<aside class="main-sidebar sidebar-dark-primary elevation-4">
         Brand Logo 
        <a th:href="@{/authenticate/socios}" class="brand-link">
            <img th:src="@{/login/static/img/user.jpg}" alt="Usuario" class="brand-image img-circle elevation-3" style="opacity: .8">
            <span class="brand-text font-weight-light">Sistema Fácil</span>
        </a>

         Sidebar 
        <div class="sidebar">
             Sidebar Menu 
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column nav-child-indent" data-widget="treeview" role="menu" data-accordion="false">
					 Configuración 
                       <li class="nav-item">
                           <a th:href="@{/panel/configuracion}" class="nav-link">
                               <i class="nav-icon fas fa-home"></i>
                               <p>Inicio</p>
                           </a>
                       </li>
					 Usuarios 
                    <li class="nav-item has-treeview">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-users"></i>
                            <p>
                                Usuarios
                                <i class="right fas fa-angle-left"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a th:href="@{/panel/usuarios}" class="nav-link">
                                    <p>Administración de Empleados</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a th:href="@{/panel/usuarios/nuevo}" class="nav-link">
                                    <p>Administración de Usuarios</p>
                                </a>
                            </li>
							<li class="nav-item">
                                <a th:href="@{/usuarios/admin/roles}" class="nav-link">
                                    <p>Administración de Roles</p>
                                </a>
                            </li>
							<li class="nav-item">
							    <a th:href="@{/usuarios/auth/roles}" class="nav-link">
							        <p>Autorizaciones por Roles</p>
							    </a>
							</li>
							<li class="nav-item">
							    <a th:href="@{/panel/usuarios/nuevo}" class="nav-link">
							        <p>Actualización de la Clave de Acceso</p>
							    </a>
							</li>
							<li class="nav-item">
							    <a th:href="@{/panel/usuarios/nuevo}" class="nav-link">
							        <p>Manual de Referencia Usuarios</p>
							    </a>
							</li>
                        </ul>
                    </li>
                    
                     Membresías 
                    <li class="nav-item has-treeview">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-id-card"></i>
                            <p>
                                Membresías
                                <i class="right fas fa-angle-left"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a th:href="@{/panel/membresias}" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Administrar</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a th:href="@{/panel/membresias/nueva}" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Nueva membresía</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                     Reportes 
                    <li class="nav-item has-treeview">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-chart-bar"></i>
                            <p>
                                Reportes
                                <i class="right fas fa-angle-left"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a th:href="@{/panel/reportes/ventas}" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Ventas</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a th:href="@{/panel/reportes/usuarios}" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Usuarios</p>
                                </a>
                            </li>
                        </ul>
                    </li>
					 Configuración 
	                       <li class="nav-item">
	                           <a th:href="@{/panel/configuracion}" class="nav-link">
	                               <i class="nav-icon fas fa-cog"></i>
	                               <p>Configuración</p>
	                           </a>
	                       </li>
                </ul>
            </nav>
        </div>
    </aside>-->
	
	<div th:replace="~{componentes/menu/menu :: sidebar-menu}"></div>


    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Content Header -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Administración de Roles</h1>
                    </div>
                </div>
            </div>
        </div>

		<!-- Modal de error -->
		<!--<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
		    <div class="modal-dialog" role="document">
		        <div class="modal-content bg-danger">
		            <div class="modal-header">
		                <h5 class="modal-title" id="errorModalLabel">Error</h5>
		                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		                    <span aria-hidden="true">&times;</span>
		                </button>
		            </div>
		            <div class="modal-body">
		                <p th:if="${errorSaveMsg != null}" th:text="${errorSaveMsg}"></p>
		            </div>
		            <div class="modal-footer">
		                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Cerrar</button>
		            </div>
		        </div>
		    </div>
		</div>-->
		
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-3"></div>
                    <div class="col-md-6">
						<div class="card card-info">					
                            <div class="card-header">
                                <h3 class="card-title">Usuarios</h3>
                            </div>
							<form id="rolForm" class="form-horizontal" th:object="${roles}" th:action="@{/usuarios/rol}" method ="post">
							    <div class="card-body">
							        <div class="form-group row">
							            <label for="inputEmail3" class="col-sm-2 col-form-label">Rol</label>
							            <div class="col-sm-10">
							                <div class="input-group">
							                    <input type="text" class="form-control" id="rol" th:field="*{rol_Descripcion}" placeholder="Rol">
							                    <div class="input-group-append">
							                        <button type="submit" class="btn btn-primary" onclick="setAccion('searchRoles')" title="Buscar rol">
							                            <i class="fas fa-search"></i>
							                        </button>
													
													<!--<button type="submit" class="btn btn-success" onclick="setAccion('saveRoles')">
							                            <i class="fas fa-save"></i>
							                        </button>-->
													<button type="button" class="btn btn-success" onclick="confirmarGuardado()" title="Guardar rol">
													    <i class="fas fa-save"></i>
													</button>
						                        </button>
							                    </div>
							                </div>
							            </div>
							        </div>
							    </div>
								<input type="hidden" name="accion" id="accion">
							</form>
							<!--<table class="table table-bordered">
							    <thead>
							        <tr>
							            <th>ID</th>
							            <th>Rol</th>
										<th>Acciones</th>
							        </tr>
							    </thead>
							    <tbody>
							        <tr th:each="rol : ${listaRoles}">
							            <td th:text="${rol.id}">1</td>
							            <td th:text="${rol.rol}">Administrador</td>
										<td>
											<button type="button" class="btn btn-danger btn-sm" 
							                        th:attr="data-id=${rol.id}" onclick="confirmarEliminacion(this)">
							                    <i class="fas fa-trash-alt"></i> 
							                </button>
							            </td>

							        </tr>
							    </tbody>
							</table>-->
							
							<div class="card">
							    <!--<div class="card-header">
							        <h3 class="card-title">Lista de Roles</h3>
							        <div class="card-tools">
							            <div class="input-group input-group-sm" style="width: 150px;">
							                <input type="text" name="table_search" class="form-control float-right" placeholder="Buscar">
							                <div class="input-group-append">
							                    <button type="submit" class="btn btn-default">
							                        <i class="fas fa-search"></i>
							                    </button>
							                </div>
							            </div>
							        </div>
							    </div>-->
							    <!-- /.card-header -->
								<div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
							    <div class="card-body table-responsive p-0">
							        <table class="table table-hover">
										<thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
							            <thead>
							                <tr>
							                    <th>ID</th>
							                    <th>Nombre del Rol</th>
												<!--<th>Estado</th>-->
							                    <th>Acciones</th>
							                </tr>
							            </thead>
							            <tbody>
							                <tr th:each="rol : ${listaRoles}"
											th:classappend="${(!rol.rol_Activo) ? 'rol-inactivo' : (rol.modulosRoles == null or rol.modulosRoles.isEmpty()) ? 'rol-sin-modulos' : ''}"
											th:attr="data-activo=${rol.rol_Activo}">
							                    <td th:text="${rol.rol_Id}">1</td>
							                    <td th:text="${rol.rol_Descripcion}">Administrador</td>
												<!--<td th:text="${rol.rol_Activo} ? 'Activo' : 'Inactivo'"></td>-->
							                    <td>
							                        <div class="btn-group">
							                            <!--<button type="button" class="btn btn-danger btn-sm" 
							                                th:attr="data-id=${rol_Id}" onclick="confirmarEliminacion(this)" title="Eliminar rol">
							                                <i class="fas fa-trash-alt"></i> 
							                            </button>-->
														<button type="button" class="btn btn-warning btn-sm btn-herencia" 
										                            th:attr="data-id=${rol_Id}"  th:if="${rol.rol_Activo}" title="Herencia de permisos">
										                        <i class="fas fa-project-diagram fa-fw"></i>
										                </button>
														<button type="button" class="btn btn-sm btn-activar" 
												            th:attr="data-id=${rol_Id}, data-activo=${rol.rol_Activo}"
												            th:classappend="${rol.rol_Activo} ? 'btn-success' : 'btn-secondary'"
												            th:title="${rol.rol_Activo} ? 'Desactivar rol' : 'Activar rol'"
												            onclick="cambiarEstado(this)">
												            <i class="fas" 
												               th:classappend="${rol.rol_Activo} ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
												        </button>

							                        </div>
							                    </td>
							                </tr>
							            </tbody>
							        </table>
							    </div>
							</div>

                        </div>
                    </div>
                    <div class="col-md-3"></div>
                </div>
            </div>
        </section>
    </div>
	
	<!-- Modal de Edición -->
	<!--<div class="modal fade" id="editarRolModal" tabindex="-1" role="dialog" aria-labelledby="editarRolModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header bg-info">
	                <h5 class="modal-title" id="editarRolModalLabel">Editar Rol</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <form id="formEditarRol" method="post" th:action="@{/usuarios/updateRole}">
	                <div class="modal-body">
	                    <input type="hidden" id="editRolId" name="id">
	                    <div class="form-group">
	                        <label for="editRolNombre">Nombre del Rol</label>
	                        <input type="text" class="form-control" id="editRolNombre" name="rol" required>
	                    </div>
	                </div>
	                <div class="modal-footer">
	                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
	                    <button type="submit" class="btn btn-info">Guardar Cambios</button>
	                </div>
	                <input type="hidden" name="_csrf" th:value="${_csrf.token}">
	            </form>
	        </div>
	    </div>
	</div>-->
	
	<!-- Modal de Edición -->
	<div class="modal fade" id="editarRolModal" tabindex="-1" role="dialog" aria-labelledby="editarRolModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-lg modal-editar-rol" role="document">
	        <div class="modal-content">
	            <div class="modal-header bg-info">
	                <h5 class="modal-title" id="editarRolModalLabel">Editar Rol</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <form id="formEditarRol" method="post" th:action="@{/usuarios/updateRole}">
	                <div class="modal-body">
	                    <input type="hidden" id="editRolId" name="id">                    
	                    <div class="card card-primary h-100">
	                        <div class="card-header">
	                            <h3 class="card-title">Módulos Asignados</h3>
	                        </div>
	                        <div class="card-body p-0">
	                            <div class="modulos-scroll-container">
	                                <div id="modulosEdicionTree">
	                                    <div class="text-center p-3 text-muted">
	                                        <i class="fas fa-spinner fa-spin"></i> Cargando módulos...
	                                    </div>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	                <div class="modal-footer">
	                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
	                    <button type="submit" class="btn btn-info">Guardar Cambios</button>
	                </div>
	                <input type="hidden" name="_csrf" th:value="${_csrf.token}">
	            </form>
	        </div>
	    </div>
	</div>
	
	<!-- Modal de Herencia -->
	<!--<div class="modal fade" id="herenciaModal" tabindex="-1" role="dialog" aria-labelledby="herenciaModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header bg-warning">
	                <h5 class="modal-title" id="herenciaModalLabel">Herencia de Permisos</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <form id="formHerencia">
	                    <input type="hidden" id="rolIdHerencia">
						<input type="hidden" id="rolNombreActual"> 
	                    <div class="form-group">
	                        <label for="rolPadre">Hereda permisos de:</label>
	                        <select class="form-control" id="rolPadre" name="rolPadre">
	                            <option value="">Seleccione un rol...</option>
	                             Las opciones se llenarán dinámicamente 
	                        </select>
	                    </div>
	                </form>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
	                <button type="button" class="btn btn-warning" id="guardarHerencia">Guardar</button>
	            </div>
	        </div>
	    </div>
	</div>
-->

<!-- Modal Combinado de Herencia y Módulos -->
<div class="modal fade" id="herenciaModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Herencia de permisos</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="rolIdHerencia">
                <input type="hidden" id="rolNombreActual"> 
                
                <!-- Sección de Herencia -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">Configurar Herencia</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Hereda permisos de:</label>
                            <select class="form-control" id="rolPadre">
                                <option value="">Seleccione un rol...</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Módulos -->
                <div id="seccionModulos" class="mt-3" style="display: none;">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Módulos Asignados</h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="modulos-scroll-container" style="max-height: 400px; overflow-y: auto;">
                                <div id="modulosTree" style="min-height: 100px;">
                                    <div class="text-center p-3 text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Seleccione un rol para cargar los módulos...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="guardarHerencia" disabled>Guardar</button>
            </div>
        </div>
    </div>
</div>
    <!-- Footer -->
    <footer class="main-footer">
        <strong>Copyright &copy; 2024-2050 <a href="https://adminlte.io">Coral Clubes</a>.</strong>
        All rights reserved.
        <div class="float-right d-none d-sm-inline-block">
            <b>Version</b> 1.0.0
        </div>
    </footer>
	<div class="sidebar-overlay"></div>
</div>

<div id="sessionModal" class="modal" style="display: none;">
		<div class="modal-dialog" style="max-width: 500px;"> <!-- Aquí controlas el tamaño -->		
			<div class="modal-content">
				<i class="fas fa-exclamation-circle text-warning" style="font-size: 60px; margin-bottom: 15px;"></i>
				<div class="modal-title">¡Sesión expirada!</p>			        		
				    <p id="modalMessage">¿Deseas continuar conectado?</p>
				    <p>Tiempo restante: <span id="countdown">30</span> segundos</p>
					<button id="continueBtn" type="button" class="btn btn-primary">
						<i class="fas fa-sign-in-alt mr-2"></i>Sí, Seguir conectado
					</button>
				    <!--<button id="continueBtn">Continuar sesión</button>-->
				</div>	
			</div>
		</div> 
	</div>

<!-- JavaScript -->
<script th:src="@{/interno/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/interno/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/interno/dist/js/adminlte.min.js}"></script>
<script th:src="@{/interno/plugins/toastr/toastr.min.js}"></script>
<script th:src="@{/interno/plugins/sweetalert2/sweetalert2.min.js}"></script>


<!-- Script para el menú -->
<script th:inline="javascript">
/*<![CDATA[*/
$(document).ready(function() {
	
	// Menú móvil
/*    $('.navbar-toggler').click(function() {
        $('body, .main-sidebar, .sidebar-overlay').toggleClass('sidebar-open');
    });
    
    $('.sidebar-overlay, .nav-link').click(function() {
        if($(window).width() < 992) {
            $('body, .main-sidebar, .sidebar-overlay').removeClass('sidebar-open');
        }
    });*/
	
	$('.navbar-toggler').click(function() {
		        $('body, .main-sidebar, .sidebar-overlay').toggleClass('sidebar-open');
		    });
		    
		    // Cerrar menú al hacer clic en cualquier parte del contenido (excepto el menú)
		 /*   $(document).on('click', function(e) {
		        // Solo aplicar en móvil (ancho menor a 992px)
		        if ($(window).width() < 992) {
		            // Si el clic no fue en el menú ni en el botón toggler
		            if (!$(e.target).closest('.main-sidebar').length && 
		                !$(e.target).closest('.navbar-toggler').length) {
		                $('body, .main-sidebar, .sidebar-overlay').removeClass('sidebar-open');
		            }
		        }
		    });*/
			
			$(document).on('click', function(e) {
					    // Solo aplicar en móvil (ancho menor a 992px)
					  if ($(window).width() < 992) {
					      // Si el clic no fue en el menú ni en el botón toggler
					      if (!$(e.target).closest('.main-sidebar').length && 
					          !$(e.target).closest('.navbar-toggler').length) {
					          $('body, .main-sidebar, .sidebar-overlay').removeClass('sidebar-open');
					      }
					  }
			});
		    
		    // Evitar que el clic dentro del menú lo cierre
		    $('.main-sidebar').on('click', function(e) {
		        e.stopPropagation();
		    });
			
			// Cerrar menú solo cuando se hace clic en un enlace que no tenga submenú
			$(document).on('click', '.nav-link:not(.has-treeview > .nav-link)', function() {
					  if ($(window).width() < 992) {
					      $('body, .main-sidebar, .sidebar-overlay').removeClass('sidebar-open');
					  }
			});
		    
		    // Cerrar menú al hacer clic en un enlace del menú (opcional)
		    /*$('.nav-link').click(function() {
		        if ($(window).width() < 992) {
		            $('body, .main-sidebar, .sidebar-overlay').removeClass('sidebar-open');
		        }
		    });*/
			
			$('.nav-link').click(function (e) {
			    if ($(window).width() < 992) {
			        const $parentLi = $(this).closest('li');

			        // Si el enlace es un padre con submenú, no cerrar
			        if ($parentLi.hasClass('has-treeview')) {
			            e.preventDefault(); // Opcional: para evitar scroll arriba
			            return;
			        }

			        // Si no tiene hijos, cerrar el menú (navegación real)
			        $('body, .main-sidebar, .sidebar-overlay').removeClass('sidebar-open');
			    }
			});
			
			$(document).on('click', '.nav-link', function (e) {
			    if ($(window).width() >= 992) return; // Solo móvil

			    const $link = $(this);
			    const $li = $link.closest('li');

			    const isToggleClick = $(e.target).hasClass('right') || $(e.target).hasClass('fa-angle-left') || $(e.target).hasClass('fa-angle-down');
			    const hasSubmenu = $li.children('.nav-treeview').length > 0;

			    if (hasSubmenu) {
			        if (!isToggleClick) {
			            e.preventDefault(); // No cerrar si no es un click de navegación
			        }
			    } else {
			        // Enlace real, cerrar sidebar después de pequeño delay
			        setTimeout(() => {
			            $('body').removeClass('sidebar-open');
			        }, 200);
			    }
			});


			$('.main-sidebar').on('click', 'a.nav-link', function (e) {
			    if ($(window).width() < 992) {
			        const $link = $(this);
			        const $li = $link.closest('li');

			        const isFinalLink = !$li.hasClass('has-treeview') && $li.find('.nav-treeview').length === 0;

			        if (isFinalLink) {
			            setTimeout(() => {
			                $('body').removeClass('sidebar-open');
			            }, 200);
			        }
			    }
			});


	
	$('#editarRolModal').on('show.bs.modal', function() {
	       if ($(window).width() >= 992) {
	           $(this).find('.modal-dialog').addClass('modal-lg');
	       } else {
	           $(this).find('.modal-dialog').removeClass('modal-lg');
	       }
	   });

	   $(window).on('resize', function() {
	       if ($('#editarRolModal').is(':visible')) {
	           if ($(window).width() >= 992) {
	               $('#editarRolModal .modal-dialog').addClass('modal-lg');
	           } else {
	               $('#editarRolModal .modal-dialog').removeClass('modal-lg');
	           }
	       }
	   });
			
    // Inicialización del treeview con configuración personalizada
    $('[data-widget="treeview"]').Treeview({
      /*  trigger: '.nav-item.has-treeview > a',
        animationSpeed: 300,*/
        accordion: true
    });
    
    // Manejo manual del clic para evitar el comportamiento no deseado
  /*  $('.nav-item.has-treeview > a').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var parent = $(this).parent();
        var treeviewMenu = $(this).next('.nav-treeview');
        var isOpen = parent.hasClass('menu-open');
        
        if (!e.originalEvent.detail || e.originalEvent.detail == 1) {
            if(isOpen) {
                parent.removeClass('menu-open');
                treeviewMenu.slideUp();
                $(this).find('.right.fas').removeClass('fa-angle-down').addClass('fa-angle-left');
            } else {
                parent.addClass('menu-open');
                treeviewMenu.slideDown();
                $(this).find('.right.fas').removeClass('fa-angle-left').addClass('fa-angle-down');
            }
        }
    });*/
	
	$('.nav-item.has-treeview > a').on('click', function (e) {
	    e.preventDefault();
	    var parent = $(this).parent();
	    var wasOpen = parent.hasClass('menu-open');

	    // Cierra todos primero
	    $('.nav-item.has-treeview').removeClass('menu-open');
	    $('.nav-item.has-treeview .nav-treeview').slideUp();

	    if (!wasOpen) {
	        parent.addClass('menu-open');
	        parent.find('> .nav-treeview').slideDown();
	    }
	});

    
    // Manejo del doble click para colapsar sin reabrirse
    $('.nav-item.has-treeview > a').on('dblclick', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var parent = $(this).parent();
        var treeviewMenu = $(this).next('.nav-treeview');
        
        parent.removeClass('menu-open');
        treeviewMenu.slideUp();
        $(this).find('.right.fas').removeClass('fa-angle-down').addClass('fa-angle-left');
        
        $(this).off('click').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
        
        setTimeout(() => {
            $('.nav-item.has-treeview > a').off('click').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                var parent = $(this).parent();
                var treeviewMenu = $(this).next('.nav-treeview');
                var isOpen = parent.hasClass('menu-open');
                
                if(isOpen) {
                    parent.removeClass('menu-open');
                    treeviewMenu.slideUp();
                    $(this).find('.right.fas').removeClass('fa-angle-down').addClass('fa-angle-left');
                } else {
                    parent.addClass('menu-open');
                    treeviewMenu.slideDown();
                    $(this).find('.right.fas').removeClass('fa-angle-left').addClass('fa-angle-down');
                }
            });
        }, 300);
    });
	
//	$('[data-widget="treeview"]').Treeview('init');
    
    // Marcar elemento activo basado en la URL
    var currentUrl = window.location.pathname;
    /*$('.nav-link').each(function() {
        if ($(this).attr('href') === currentUrl) {
            $(this).addClass('active');
            var treeview = $(this).closest('.nav-treeview');
            if(treeview.length) {
                treeview.show();
                treeview.prev('a').find('.right.fas').removeClass('fa-angle-left').addClass('fa-angle-down');
                treeview.closest('.has-treeview').addClass('menu-open');
            }
        }
    });*/
	
	$('.nav-link').each(function() {
		        if ($(this).attr('href') === currentUrl) {
		            $(this).addClass('active');
		            $(this).closest('.has-treeview').addClass('menu-open');
		        }
		    });

    // Mostrar notificación si hay mensajes
    const errorMsg = /*[[${msg}]]*/ null;
    const isError = /*[[${success == false}]]*/ false;
            
    if (errorMsg) {
        Swal.fire({
            title: isError ? 'Error' : 'Éxito',
            text: errorMsg,
            icon: isError ? 'error' : 'success',
            confirmButtonText: 'Entendido',
            confirmButtonColor: isError ? '#d33' : '#28a745',
            backdrop: isError ? `
                url("/interno/dist/img/error-animation.gif")
                left top
                no-repeat
            ` : ''
        });
    }

    // =============================================
    // NUEVAS FUNCIONALIDADES PARA LA TABLA DE ROLES
    // =============================================

    // Doble click en nombre de rol para editar (manteniendo funcionalidad existente)
	$(document).on('dblclick', 'tbody tr td:nth-child(2)', function(e) {
	    if ($(e.target).is('button, i, a, select')) return;
	    abrirModalEdicion($(this).closest('tr'));
	}).css('cursor', 'pointer');

	// Evento para móvil (toque único con delay)
	let lastTap = 0;
	$(document).on('click', 'tbody tr td:nth-child(2)', function(e) {
	    if ($(window).width() >= 992) return; // Solo para móviles
	    if ($(e.target).is('button, i, a, select')) return;
	    
	    const now = new Date().getTime();
	    const timesince = now - lastTap;
	    
	    if (timesince < 300 && timesince > 0) {
	        // Doble toque detectado
	        abrirModalEdicion($(this).closest('tr'));
	    }
	    lastTap = now;
	});
	
	function abrirModalEdicion(row) {
	    const rolId = row.find('td:first-child').text();
	    const rolNombre = row.find('td:nth-child(2)').text();
	    
	    $('#editRolId').val(rolId);
	    $('#editRolNombre').val(rolNombre);
	    
	    cargarModulosParaEdicion(rolId);
	    $('#editarRolModal').modal('show');
	}

    // Click simple para expandir fila con combobox "Hereda"
    $(document).on('click', 'tbody tr', function(e) {
        if ($(e.target).is('button, i, a, select, option')) return;
        if (e.originalEvent.detail > 1) return; // Ignorar doble click
        
        const row = $(this);
        let detailRow = row.next('.detail-row');
        
        if (!detailRow.length) {
            const rolId = row.find('td:first-child').text();
            detailRow = $(`
                <tr class="detail-row">
                    <td colspan="3">
                        <div class="pl-4 pr-4 pb-3">
                            <form class="form-inline hereda-form">
                                <label class="mr-2">Hereda de:</label>
                                <select class="form-control form-control-sm mr-2 hereda-select">
                                    <option value="">Seleccione un rol...</option>
                                    <option th:each="r : ${listaRoles}" 
                                            th:value="${r.id}" 
                                            th:text="${r.rol}"
                                            th:if="${r.id != rol.id}"></option>
                                </select>
                                <button type="button" class="btn btn-info btn-sm guardar-hereda">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            `);
            row.after(detailRow);
            cargarDatosHerencia(rolId, detailRow);
        }
        
        $('.detail-row').not(detailRow).slideUp();
        detailRow.slideToggle();
        row.toggleClass('table-active');
        $('tbody tr').not(row).removeClass('table-active');
    });

    // Guardar relación de herencia
    $(document).on('click', '.guardar-hereda', function() {
        const form = $(this).closest('.hereda-form');
        const rolId = form.closest('tr').prev().find('td:first-child').text();
        const heredaDe = form.find('.hereda-select').val();
        
        // Aquí iría tu llamada AJAX para guardar
        Swal.fire({
            title: 'Guardar herencia',
            text: `¿Deseas que el rol ID ${rolId} herede de ${heredaDe || 'ningún rol'}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // Ejemplo de llamada AJAX:
                
                $.post('/portal-facil/usuarios/roles/saveInheritance', {
                    rolId: rolId,
                    heredaDe: heredaDe,
                    _csrf: $('input[name="_csrf"]').val()
                }).done(function() {
                    Swal.fire('Éxito', 'La herencia se guardó correctamente', 'success');
                }).fail(function() {
                    Swal.fire('Error', 'No se pudo guardar la herencia', 'error');
                });
                
                Swal.fire('Éxito', 'Relación de herencia guardada', 'success');
            }
        });
    });

    // Manejar el envío del formulario de edición
	$('#formEditarRol').on('submit', function(e) {
	    e.preventDefault();
	    
	    const rolId = $('#editRolId').val();
	    
	    // Obtener los módulos seleccionados
	    const modulosSeleccionados = [];
	    $('#modulosEdicionTree .modulo-checkbox:checked').each(function() {
	        modulosSeleccionados.push(parseInt($(this).data('id')));
	    });
		debugger
		if (modulosSeleccionados.length === 0) {
		        Swal.fire({
		            title: 'Error',
		            text: 'Debe seleccionar al menos un módulo para el rol',
		            icon: 'error',
		            confirmButtonColor: '#dc3545'
		        });
		        return;
		    }
	    debugger
	    // Primero actualizamos el nombre del rol
	    const csrfToken = $('meta[name="_csrf"]').attr('content');
	    const csrfHeader = $('meta[name="_csrf-header"]').attr('content');
	    
	    // Mostrar loading
	   /* Swal.fire({
	        title: 'Guardando cambios',
	        html: 'Actualizando rol y módulos...',
	        allowOutsideClick: false,
	        didOpen: () => {
	            Swal.showLoading();
	        }
	    });*/
	    
	     actualizarModulosRol(rolId, modulosSeleccionados, csrfToken);

	});
	
	//Btn Herencia
	
	$(document).on('click', '.btn-herencia', function(e) {
	    e.preventDefault();
	    e.stopPropagation();
	    debugger
		//const rolId = $(this).data('id');
		//const $row = $(this).closest('tr');
		const rolId = $(this).closest('tr').find('td:nth-child(1)').text();
	    const rolNombre = $(this).closest('tr').find('td:nth-child(2)').text();
	    
	    // Configurar el modal
	    $('#rolIdHerencia').val(rolId);
		$('#rolNombreActual').val(rolNombre);
	    $('#herenciaModalLabel').text(`Herencia de permisos para ${rolNombre}`);
	    
	    // Limpiar selecciones previas
	    $('#rolPadre').val('');
	   // $('#heredarTodos').prop('checked', false);
	    
	    // Aquí puedes cargar los roles disponibles si es necesario
		cargarRolesDisponibles(rolId);
		//cargarArbolModulos(); 
	    // Mostrar modal
	    $('#herenciaModal').modal('show');
	});
	
	
	/*$('#guardarHerencia').on('click', function() {
		debugger
	    const rolId = $('#rolIdHerencia').val();
	    const rolNombreActual = $('#rolNombreActual').val(); // Obtenemos el nombre del rol actual
	    const rolPadreId = $('#rolPadre').val();
	    const rolPadreNombre = $('#rolPadre option:selected').text(); // Obtenemos el texto del rol seleccionado
		
		// Obtener todos los módulos seleccionados
		    const modulosSeleccionados = [];
		    $('#modulosTree .modulo-checkbox:checked').each(function() {
		        modulosSeleccionados.push(parseInt($(this).data('id')));
		    });
			debugger
	    
	    if (!rolPadreId) {
	        Swal.fire({
	            title: 'Selección requerida',
	            text: 'Por favor selecciona un rol del cual heredar permisos',
	            icon: 'warning'
	        });
	        return;
	    }
	    
	    Swal.fire({
	        title: 'Guardar herencia',
	        text: `¿Estás seguro de que deseas que el rol "${rolNombreActual}" herede permisos del rol "${rolPadreNombre}"?`,
	        icon: 'question',
	        showCancelButton: true,
	        confirmButtonText: 'Guardar',
	        cancelButtonText: 'Cancelar'
	    }).then((result) => {
	        if (result.isConfirmed) {
				const csrfToken = $('meta[name="_csrf"]').attr('content');
				const csrfHeader = $('meta[name="_csrf-header"]').attr('content');
	            $.ajax({
	                url: '/portal-facil/usuarios/roles/saveInheritance',
	                type: 'POST',
					contentType: 'application/json', // Importante para el backend
		            data: JSON.stringify({
		                rolId: parseInt(rolId),
		                rolPadreId: parseInt(rolPadreId),
						modulosSeleccionados: modulosSeleccionados
		            }),
		            headers: {
		                'X-CSRF-TOKEN': csrfToken // Envía el token en el header
		            },
	                success: function(response) {
	                    Swal.fire({
	                        title: 'Éxito',
	                        text: 'La herencia de permisos se ha guardado correctamente',
	                        icon: 'success',
							confirmButtonText: 'Aceptar'
	                    });
	                    $('#herenciaModal').modal('hide');
						window.location.reload();
	                },
	                error: function() {
	                    Swal.fire({
	                        title: 'Error',
	                        text: 'No se pudo guardar la herencia de permisos',
	                        icon: 'error'
	                    });
	                }
	            });
	        }
	    });
	});*/
	
	// Reemplaza el evento actual con este:
	$(document).on('click', '#guardarHerencia', function(e) {
	    e.preventDefault();
	    
	    const rolId = $('#rolIdHerencia').val();
	    const rolNombreActual = $('#rolNombreActual').val();
	    const rolPadreId = $('#rolPadre').val();
	    const rolPadreNombre = $('#rolPadre option:selected').text();
	    
	    // Validación básica
	    if (!rolPadreId) {
	        Swal.fire({
	            title: 'Selección requerida',
	            text: 'Por favor selecciona un rol del cual heredar permisos',
	            icon: 'warning'
	        });
	        return;
	    }
	    
	    // Obtener módulos seleccionados
	    const modulosSeleccionados = [];
	    $('#modulosTree .modulo-checkbox:checked').each(function() {
	        modulosSeleccionados.push(parseInt($(this).data('id')));
	    });
		debugger
		if (modulosSeleccionados.length === 0) {
		        Swal.fire({
		            title: 'Error',
		            text: 'Debe seleccionar al menos un módulo para el rol',
		            icon: 'error',
		            confirmButtonColor: '#dc3545'
		        });
		        return;
		    }
	    debugger
	    // Mostrar confirmación
	    Swal.fire({
	        title: 'Confirmar herencia',
	        html: `¿Estás seguro de que deseas que el rol <strong>${rolNombreActual}</strong> herede permisos del rol <strong>${rolPadreNombre}</strong>?`,
	        icon: 'question',
	        showCancelButton: true,
	        confirmButtonText: 'Sí, guardar',
	        cancelButtonText: 'Cancelar',
	        confirmButtonColor: '#28a745',
	        cancelButtonColor: '#d33',
	        reverseButtons: true
	    }).then((result) => {
	        if (result.isConfirmed) {
	            // Configurar AJAX
	            const csrfToken = $('meta[name="_csrf"]').attr('content');
	            const csrfHeader = $('meta[name="_csrf-header"]').attr('content');
	            
	            $.ajax({
	                url: '/portal-facil/usuarios/roles/saveInheritance',
	                type: 'POST',
	                contentType: 'application/json',
	                data: JSON.stringify({
	                    rolId: parseInt(rolId),
	                    rolPadreId: parseInt(rolPadreId),
	                    modulosSeleccionados: modulosSeleccionados
	                }),
	                headers: {
	                    'X-CSRF-TOKEN': csrfToken
	                },
	                beforeSend: function() {
	                    // Mostrar loader
	                    Swal.showLoading();
	                },
	                success: function(response) {
	                    if (response.success) {
	                        Swal.fire({
	                            title: 'Éxito',
	                            text: response.message || 'La herencia se guardó correctamente',
	                            icon: 'success'
	                        }).then(() => {
	                            $('#herenciaModal').modal('hide');
	                            window.location.reload();
	                        });
	                    } else {
	                        Swal.fire({
	                            title: 'Error',
	                            text: response.message || 'Ocurrió un error al guardar',
	                            icon: 'error'
	                        });
	                    }
	                },
	                error: function(xhr) {
	                    let errorMsg = 'Error al procesar la solicitud';
	                    if (xhr.responseJSON && xhr.responseJSON.message) {
	                        errorMsg = xhr.responseJSON.message;
	                    }
	                    Swal.fire({
	                        title: 'Error',
	                        text: errorMsg,
	                        icon: 'error'
	                    });
	                }
	            });
	        }
	    });
	});
	
	
	
	$('#herenciaModal').on('show.bs.modal', function() {
	        // Resetear el formulario
	        $('#rolPadre').val('');
	        $('#seccionModulos').hide();
	        $('#guardarHerencia').prop('disabled', true);
	        
	        // Limpiar el árbol de módulos
	        $('#modulosTree').html('<div class="text-center p-3 text-muted">Seleccione un rol para ver los módulos</div>');
	    });

	    // Evento al cambiar la selección del rol
	    $('#rolPadre').on('change', function() {
	        if ($(this).val()) {
	            // Mostrar sección de módulos
	            $('#seccionModulos').slideDown();
	            
	            // Cargar árbol de módulos (sin parámetros como lo necesitas)
	            cargarArbolModulos($(this).val());
	            
	            // Habilitar botón de guardar
	            $('#guardarHerencia').prop('disabled', false);
	        } else {
	            // Ocultar sección de módulos
	            $('#seccionModulos').slideUp();
	            
	            // Deshabilitar botón de guardar
	            $('#guardarHerencia').prop('disabled', true);
	        }
	    });
});

// Función para cargar datos de herencia
function cargarDatosHerencia(rolId, detailRow) {
    // Implementa tu lógica para cargar la herencia actual
    // Ejemplo:
    /*
    $.get('/api/roles/' + rolId + '/herencia', function(data) {
        if (data.heredaDe) {
            detailRow.find('.hereda-select').val(data.heredaDe);
        }
    });
    */
}

function cargarRolesDisponibles(rolActualId) {
    $('#rolPadre').html('<option value="">Cargando roles...</option>');
    
    $.ajax({
        url: '/portal-facil/usuarios/loadRolesJson',
        type: 'POST',
        dataType: 'json',
        data: {
            _csrf: $('input[name="_csrf"]').val()
        },
        success: function(roles) {
            const $select = $('#rolPadre');
            $select.empty();
            $select.append('<option value="">Seleccione un rol...</option>');
            
            //const rolActualId = $('#rolIdHerencia').val();
			console.log('rolActualId:' + rolActualId)
            debugger
            roles.forEach(rol => {
				debugger
                if (rol.id && rol.nombre && rol.id !== rolActualId) {
                    $select.append(`<option value="${rol.id}">${rol.nombre}</option>`);
                }
            });
        },
        error: function(xhr, status, error) {
            console.error('Error al cargar roles:', error);
            $('#rolPadre').html('<option value="">Error al cargar roles</option>');
            
            Swal.fire({
                title: 'Error',
                text: 'No se pudieron cargar los roles disponibles',
                icon: 'error'
            });
        }
    });
}
// Funciones existentes que debes mantener
function saveRole(event) {
    event.preventDefault();
    const form = document.getElementById("rolForm");
    form.action = "/usuarios/saveRole";
    form.submit();
}

function setAccion(valor) {
    document.getElementById("accion").value = valor;
}

function confirmarGuardado() {
    const rolInput = document.getElementById('rol');
    const rolValue = rolInput.value.trim();
    
    if (!rolValue) {
        Swal.fire({
            title: 'Campo vacío',
            text: 'No se puede guardar un rol sin nombre. Por favor ingresa un nombre para el rol.',
            icon: 'warning',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'Aceptar'
        });
        rolInput.focus();
        return;
    }
    
    Swal.fire({
        title: '¿Guardar Rol?',
        text: "¿Estás seguro de que deseas guardar este nuevo rol?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#dc3545',
        confirmButtonText: 'Sí, guardar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('accion').value = 'saveRoles';
            document.getElementById('rolForm').submit();
        }
    });
}

function confirmarEliminacion(button) {
    //const rolId = $(button).data('id');
	const rolId = $(button).closest('tr').find('td:nth-child(1)').text();
    const rolNombre = $(button).closest('tr').find('td:nth-child(2)').text();
    
    Swal.fire({
        title: '¿Eliminar rol?',
        html: `¿Estás seguro de eliminar el rol <b>${rolNombre}</b>?<br><small>Esta acción no se puede deshacer</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        backdrop: `
            url("/interno/dist/img/trash-animation.gif")
            left top
            no-repeat
        `
    }).then((result) => {
        if (result.isConfirmed) {
            eliminarRol(rolId);
        }
    });
}

function eliminarRol(id) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/portal-facil/usuarios/deleterole';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = '_csrf';
    csrfToken.value = /*[[${_csrf.token}]]*/ '';
    form.appendChild(csrfToken);
    
    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.name = 'id';
    idInput.value = id;
    form.appendChild(idInput);
    
    document.body.appendChild(form);
    form.submit();
    setTimeout(() => document.body.removeChild(form), 100);
}

function cambiarEstado(button) {
    const rolId = $(button).closest('tr').find('td:nth-child(1)').text();
    const rolNombre = $(button).closest('tr').find('td:nth-child(2)').text();
    const estaActivo = $(button).data('activo') === true;
    
    Swal.fire({
        title: estaActivo ? '¿Desactivar rol?' : '¿Activar rol?',
        html: `¿Estás seguro de querer ${estaActivo ? 'desactivar' : 'activar'} el rol <b>${rolNombre}</b>?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: estaActivo ? '#6c757d' : '#28a745',
        cancelButtonColor: '#d33',
        confirmButtonText: estaActivo ? 'Sí, desactivar' : 'Sí, activar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Llamada AJAX para cambiar el estado
            const csrfToken = $('meta[name="_csrf"]').attr('content');
            const csrfHeader = $('meta[name="_csrf-header"]').attr('content');
            
            $.ajax({
                url: '/portal-facil/usuarios/role/cambiarEstadoRol',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    rolId: parseInt(rolId),
                    nuevoEstado: !estaActivo
                }),
                headers: {
                    'X-CSRF-TOKEN': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Éxito',
                            text: response.message,
                            icon: 'success'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: response.message,
                            icon: 'error'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudo cambiar el estado del rol',
                        icon: 'error'
                    });
                }
            });
        }
    });
}

// Función para cargar y generar el árbol de módulos
function cargarArbolModulos(rolIdSeleccionado) {
    const $treeContainer = $('#modulosTree');
    $treeContainer.html(`
        <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Cargando módulos...</p>
            </div>
        </div>
    `);

    // Cargamos todos los módulos disponibles
    $.ajax({
        url: '/portal-facil/usuarios/loadModulosJson',
        type: 'POST',
        dataType: 'json',
        headers: {
            [$('meta[name="_csrf-header"]').attr('content')]: $('meta[name="_csrf"]').attr('content')
        },
        success: function(modulosData) {
            if (!modulosData?.length) {
                $treeContainer.html('<div class="alert alert-info">No se encontraron módulos</div>');
                return;
            }

            // Si hay un rol seleccionado, cargamos sus módulos asignados
            if (rolIdSeleccionado) {
                $.ajax({
                    url: '/portal-facil/usuarios/getModulosRol',
                    type: 'POST',
                    data: {
                        rolId: rolIdSeleccionado,
                        _csrf: $('meta[name="_csrf"]').attr('content')
                    },
                    dataType: 'json',
                    success: function(modulosAsignados) {
                        renderizarArbol(modulosData, modulosAsignados);
                    },
                    error: function() {
                        renderizarArbol(modulosData, []);
                    }
                });
            } else {
                renderizarArbol(modulosData, []);
            }
        },
        error: function() {
            $treeContainer.html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Error al cargar los módulos
                </div>
            `);
        }
    });

    function renderizarArbol(modulosData, modulosAsignados) {
        // Extraemos los IDs de los módulos asignados (usando rom_mdl_id)
        const modulosAsignadosIds = modulosAsignados.map(mod => mod.rom_mdl_id);
        
        // Función para construir el árbol
		function construirArbol(padreId, nivel = 0) {
		        const hijos = modulosData
		            .filter(mod => mod.mdl_padre_id == padreId)
		            .sort((a, b) => a.mdl_orden - b.mdl_orden);
		        
		        if (!hijos.length) return '';

		        return `
		            <ul class="nav nav-treeview" ${nivel > 0 ? 'style="display:none;"' : ''}>
		                ${hijos.map(mod => {
		                    const tieneHijos = modulosData.some(m => m.mdl_padre_id == mod.mdl_id);
		                    const estaMarcado = modulosAsignadosIds.includes(mod.mdl_id.toString());
		                    const esPadre = modulosData.some(m => m.mdl_padre_id === mod.mdl_id);
		                    
		                    return `
		                        <li class="nav-item${tieneHijos ? ' has-treeview' : ''} ${nivel > 0 ? 'modulo-hijo' : ''}">
		                            <a href="#" class="nav-link">
		                                <input type="checkbox" class="modulo-checkbox mr-2" 
		                                       id="mod_${mod.mdl_id}" 
		                                       data-id="${mod.mdl_id}"
		                                       ${estaMarcado ? 'checked' : ''}>
		                                <span class="${esPadre ? 'modulo-padre' : ''}">${mod.mdl_nombre}</span>
		                                ${tieneHijos ? '<i class="right fas fa-angle-left"></i>' : ''}
		                            </a>
		                            ${tieneHijos ? construirArbol(mod.mdl_id, nivel + 1) : ''}
		                        </li>
		                    `;
		                }).join('')}
		            </ul>
		        `;
		    }

        // Encontrar raíz
        const idRaiz = modulosData.find(mod => 
            !modulosData.some(m => m.mdl_id === mod.mdl_padre_id)
        )?.mdl_padre_id || Math.min(...modulosData.map(mod => mod.mdl_padre_id).filter(id => id !== null));

        // Renderizar árbol
        $treeContainer.html(construirArbol(idRaiz));
        
        // Inicializar treeview manualmente
        initCustomTreeView();
    }
}

// Inicialización manual del treeview
function initCustomTreeView() {
    // Manejo de la expansión/colapso
    $('#modulosTree').off('click').on('click', '.has-treeview > .nav-link', function(e) {
        if ($(e.target).is('input[type="checkbox"]')) return;
        
        e.preventDefault();
        const $li = $(this).parent();
        const $treeview = $li.children('.nav-treeview');
        const $icon = $(this).find('.right.fas');
        
        $li.toggleClass('menu-open');
        
        if ($li.hasClass('menu-open')) {
            $treeview.slideDown(200);
            $icon.removeClass('fa-angle-left').addClass('fa-angle-down');
        } else {
            $treeview.slideUp(200);
            $icon.removeClass('fa-angle-down').addClass('fa-angle-left');
        }
    });
    
    // Mostrar el primer nivel
    $('#modulosTree > .nav-treeview').show();
    
    // Manejo de checkboxes para padres/hijos
    $('#modulosTree').on('change', '.modulo-checkbox', function() {
        const $checkbox = $(this);
        const $li = $checkbox.closest('.nav-item');
        const isChecked = $checkbox.prop('checked');
        
        // Marcar/desmarcar todos los hijos
        $li.find('.modulo-checkbox').prop('checked', isChecked);
        
        // Manejar estado de los padres
        if (isChecked) {
            // Si se marca un hijo, marcar todos sus padres
            $li.parents('.nav-item').each(function() {
                $(this).find('> .nav-link > .modulo-checkbox').prop('checked', true);
            });
        } else {
            // Si se desmarca un hijo, verificar si hay que desmarcar padres
            $li.parents('.nav-item').each(function() {
                const $parentCheckbox = $(this).find('> .nav-link > .modulo-checkbox');
                const anySiblingChecked = $(this).find('> .nav-treeview .modulo-checkbox:checked').length > 0;
                if (!anySiblingChecked) {
                    $parentCheckbox.prop('checked', false);
                }
            });
        }
    });
}

function cargarModulosParaEdicion(rolId) {
    const $treeContainer = $('#modulosEdicionTree');
    $treeContainer.html(`
        <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2">Cargando módulos...</p>
            </div>
        </div>
    `);

    // Cargamos todos los módulos disponibles y los asignados al rol
    $.when(
        $.ajax({
            url: '/portal-facil/usuarios/loadModulosJson',
            type: 'POST',
            dataType: 'json',
            headers: {
                [$('meta[name="_csrf-header"]').attr('content')]: $('meta[name="_csrf"]').attr('content')
            }
        }),
        $.ajax({
            url: '/portal-facil/usuarios/getModulosRol',
            type: 'POST',
            data: {
                rolId: rolId,
                _csrf: $('meta[name="_csrf"]').attr('content')
            },
            dataType: 'json'
        })
    ).then(function(modulosData, modulosAsignados) {
        // Procesar los resultados
        const modulos = modulosData[0];
        const asignados = modulosAsignados[0];
        
        if (!modulos?.length) {
            $treeContainer.html('<div class="alert alert-info">No se encontraron módulos</div>');
            return;
        }

        // Extraemos los IDs de los módulos asignados
        const modulosAsignadosIds = asignados.map(mod => mod.rom_mdl_id);
        
        // Función para construir el árbol
		function construirArbol(padreId, nivel = 0) {
		    const hijos = modulos
		        .filter(mod => mod.mdl_padre_id == padreId)
		        .sort((a, b) => a.mdl_orden - b.mdl_orden);
		    
		    if (!hijos.length) return '';

		    return `
		        <ul class="nav nav-treeview" ${nivel > 0 ? 'style="display:none;"' : ''}>
		            ${hijos.map(mod => {
		                const tieneHijos = modulos.some(m => m.mdl_padre_id == mod.mdl_id);
		                const estaMarcado = modulosAsignadosIds.includes(mod.mdl_id.toString());
		                const esPadre = modulos.some(m => m.mdl_padre_id === mod.mdl_id);
		                
		                return `
		                    <li class="nav-item${tieneHijos ? ' has-treeview' : ''} ${nivel > 0 ? 'modulo-hijo' : ''}">
		                        <a href="#" class="nav-link">
		                            <input type="checkbox" class="modulo-checkbox mr-2" 
		                                   id="mod_edit_${mod.mdl_id}" 
		                                   data-id="${mod.mdl_id}"
		                                   ${estaMarcado ? 'checked' : ''}>
		                            <span class="${esPadre ? 'modulo-padre' : ''}">${mod.mdl_nombre}</span>
		                            ${tieneHijos ? '<i class="right fas fa-angle-left"></i>' : ''}
		                        </a>
		                        ${tieneHijos ? construirArbol(mod.mdl_id, nivel + 1) : ''}
		                    </li>
		                `;
		            }).join('')}
		        </ul>
		    `;
		}

        // Encontrar raíz
        const idRaiz = modulos.find(mod => 
            !modulos.some(m => m.mdl_id === mod.mdl_padre_id)
        )?.mdl_padre_id || Math.min(...modulos.map(mod => mod.mdl_padre_id).filter(id => id !== null));

        // Renderizar árbol
        $treeContainer.html(construirArbol(idRaiz));
        
        // Inicializar treeview manualmente
        initCustomTreeView('#modulosEdicionTree');
    }).fail(function() {
        $treeContainer.html(`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Error al cargar los módulos
            </div>
        `);
    });
}

function initCustomTreeView(selector = '#modulosTree') {
    // Manejo de la expansión/colapso
    $(selector).off('click').on('click', '.has-treeview > .nav-link', function(e) {
        if ($(e.target).is('input[type="checkbox"]')) return;
        
        e.preventDefault();
        const $li = $(this).parent();
        const $treeview = $li.children('.nav-treeview');
        const $icon = $(this).find('.right.fas');
        
        $li.toggleClass('menu-open');
        
        if ($li.hasClass('menu-open')) {
            $treeview.slideDown(200);
            $icon.removeClass('fa-angle-left').addClass('fa-angle-down');
        } else {
            $treeview.slideUp(200);
            $icon.removeClass('fa-angle-down').addClass('fa-angle-left');
        }
    });
    
    // Mostrar el primer nivel
    $(selector + ' > .nav-treeview').show();
    
    // Manejo de checkboxes para padres/hijos
    $(selector).on('change', '.modulo-checkbox', function() {
        const $checkbox = $(this);
        const $li = $checkbox.closest('.nav-item');
        const isChecked = $checkbox.prop('checked');
        
        // Marcar/desmarcar todos los hijos
        $li.find('.modulo-checkbox').prop('checked', isChecked);
        
        // Manejar estado de los padres
        if (isChecked) {
            // Si se marca un hijo, marcar todos sus padres
            $li.parents('.nav-item').each(function() {
                $(this).find('> .nav-link > .modulo-checkbox').prop('checked', true);
            });
        } else {
            // Si se desmarca un hijo, verificar si hay que desmarcar padres
            $li.parents('.nav-item').each(function() {
                const $parentCheckbox = $(this).find('> .nav-link > .modulo-checkbox');
                const anySiblingChecked = $(this).find('> .nav-treeview .modulo-checkbox:checked').length > 0;
                if (!anySiblingChecked) {
                    $parentCheckbox.prop('checked', false);
                }
            });
        }
    });
}

function actualizarModulosRol(rolId, modulosSeleccionados, csrfToken) {
    $.ajax({
        url: '/portal-facil/usuarios/roles/editModulesRoles',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            rolId: rolId,
            modulosSeleccionados: modulosSeleccionados
        }),
        headers: {
            'X-CSRF-TOKEN': csrfToken
        },
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    title: '¡Éxito!',
                    text: 'El rol y sus módulos se actualizaron correctamente',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                }).then(() => {
                    $('#editarRolModal').modal('hide');
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: response.message || 'Error al actualizar los módulos del rol',
                    icon: 'error'
                });
            }
        },
        error: function(xhr) {
            Swal.fire({
                title: 'Error',
                text: 'Error al actualizar los módulos del rol: ' + (xhr.responseJSON?.message || xhr.responseText),
                icon: 'error'
            });
        }
    });
}

/*]]>*/
</script>

<!-- Script para colapsar/expandir -->
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', function() {
    // 1. Inicialización del treeview
    $('[data-widget="treeview"]').Treeview({
        collapseAll: true,
        expandSpeed: 0
    });

    // 2. Obtener el identificador de página activa del modelo Thymeleaf
    var paginaActiva = /*[[${menuActivo}]]*/ null;
    var currentUrl = window.location.pathname.toLowerCase(); // Convertir a minúsculas para comparación
	
	console.log('Pagina activa desde modelo:', paginaActiva);
	console.log('Current URL:', currentUrl);
	console.log('Todos los data-menu-id:', $('[data-menu-id]').map(function() { 
	    return $(this).data('menu-id'); 
	}).get());
    
    // 3. Función para activar menú mejorada
   /* function activarMenu(id) {
        // Limpiar activos previos
        $('.nav-link').removeClass('active');
        $('.has-treeview').removeClass('menu-open');
        
        // Buscar coincidencia sin importar mayúsculas/minúsculas
        $('[data-menu-id]').each(function() {
            if($(this).data('menu-id').toLowerCase() === id.toLowerCase()) {
                $(this).addClass('active')
                    .closest('.has-treeview').addClass('menu-open')
                    .find('> .nav-treeview').show();
                return false; // Salir del bucle una vez encontrado
            }
        });
    }*/
	
	function activarMenu(id) {
		    // Limpiar activos previos
		    $('.nav-link').removeClass('active');
		    $('.has-treeview').removeClass('menu-open');
		    $('.nav-treeview').hide();

		    // Buscar coincidencia sin importar mayúsculas/minúsculas
		    $('[data-menu-id]').each(function () {
		        if ($(this).data('menu-id') && $(this).data('menu-id').toLowerCase() === id.toLowerCase()) {
		            $(this).addClass('active');

		            // Abrir todos los ancestros has-treeview
		            $(this).parents('.has-treeview').addClass('menu-open');

		            // Mostrar todos los submenús padres (nav-treeview)
		            $(this).parents('.nav-treeview').show();

		            return false; // Salir del each
		        }
		    });
		}
    
    // 4. Resaltar menú basado en URL o identificador
    if (paginaActiva) {
        activarMenu(paginaActiva);
    } 
    else if (currentUrl.includes('/usuarios/adminroles') || 
             currentUrl.includes('/usuarios/rol')) {
        activarMenu('smnuAdministracionRoles');
    }
    else {
        // Caso 2: Fallback a detección por URL
        $('.nav-link').each(function() {
            var linkUrl = $(this).attr('href');
            if (linkUrl && 
               (currentUrl === linkUrl.toLowerCase() || 
                (linkUrl !== '/' && currentUrl.startsWith(linkUrl.toLowerCase())))) {
                activarMenu($(this).data('menu-id'));
            }
        });
    }
});

let inactivityTime = 1 * 60 * 1000; // 10 minutos
let countdownTime = 30;
let countdownInterval;
let inactivityTimer;

function startInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(showSessionModal, inactivityTime);
}

function showSessionModal() {
	
  const modal = document.getElementById("sessionModal");
  const message = document.getElementById("modalMessage");
  const countdown = document.getElementById("countdown");
  const continueBtn = document.getElementById("continueBtn");

  countdownTime = 30;
  countdown.textContent = countdownTime;
  modal.style.display = "flex";

  countdownInterval = setInterval(() => {
    countdownTime--;
    countdown.textContent = countdownTime;
    if (countdownTime <= 0) {
      clearInterval(countdownInterval);
      endSession();
    }
  }, 1000);

  continueBtn.onclick = () => {
    clearInterval(countdownInterval);
    modal.style.display = "none";
    fetch("/keep-alive"); // Llama al backend para renovar la sesión
    startInactivityTimer(); // Reinicia conteo
  };
}

function endSession() {
  const modal = document.getElementById("sessionModal");
  document.getElementById("modalMessage").textContent = "Sesión terminada. Vuelva a ingresar.";
  document.getElementById("countdown").style.display = "none";
  document.getElementById("continueBtn").style.display = "none";

  setTimeout(() => {
    window.location.href = contextRoot+"logout"; // Redirige al logout
  }, 3000);
}

["click", "mousemove", "keydown"].forEach(event =>
  document.addEventListener(event, startInactivityTimer)
);

startInactivityTimer();
/*]]>*/
</script>
</body>